name: Terraform Deploy

on:
  push:
    branches: [ main ]

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      bucket: ${{ steps.bucket.outputs.name }}
      dist: ${{ steps.dist.outputs.id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init \
          -backend-config="bucket=${{ vars.TF_STATE_BUCKET }}" \
          -backend-config="key=terraform/state.tfstate" \
          -backend-config="region=${{ vars.AWS_REGION }}" \
          -backend-config="dynamodb_table=${{ vars.TF_LOCK_TABLE }}" \
          -backend-config="encrypt=true"

      - name: Terraform Apply
        working-directory: infra/terraform
        run: terraform apply -auto-approve

      - name: Get bucket name
        id: bucket
        working-directory: infra/terraform
        run: echo "name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
      - name: Get distribution id
        id: dist
        working-directory: infra/terraform
        run: echo "id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Sync site to S3
        run: |
          aws s3 sync . "s3://${{ needs.terraform.outputs.bucket }}" \
            --exclude ".git/*" \
            --exclude "infra/*" \
            --exclude "*.tfstate*" \
            --exclude "node_modules/*" \
            --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ needs.terraform.outputs.dist }}" \
            --paths "/*"
