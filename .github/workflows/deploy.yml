name: Terraform Deploy

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    outputs:
      bucket: ${{ steps.bucket.outputs.name }}
      dist: ${{ steps.dist.outputs.id }}
      rest_api: ${{ steps.api_rest.outputs.url }}
      ws_api: ${{ steps.ws_api.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: infra/terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET }}" \
            -backend-config="key=terraform/state.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        working-directory: infra/terraform
        run: terraform apply -auto-approve

      - name: Get bucket name
        id: bucket
        working-directory: infra/terraform
        run: echo "name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
      - name: Get distribution id
        id: dist
        working-directory: infra/terraform
        run: echo "id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
      - name: Get REST API url
        id: api_rest
        working-directory: infra/terraform
        run: echo "url=$(terraform output -raw rest_api_url)" >> $GITHUB_OUTPUT
      - name: Get WebSocket API url
        id: ws_api
        working-directory: infra/terraform
        run: echo "url=$(terraform output -raw ws_api_url)" >> $GITHUB_OUTPUT
  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Sync site to S3
        run: |
          API_BASE="${{ needs.terraform.outputs.rest_api }}"
          echo "window.API_BASE=\"${API_BASE}\";" > frontend/js/config.js
          echo "window.WS_BASE=\"${{ needs.terraform.outputs.ws_api }}\";" >> frontend/js/config.js
          aws s3 sync frontend "s3://${{ needs.terraform.outputs.bucket }}" --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ needs.terraform.outputs.dist }}" \
            --paths "/*"
